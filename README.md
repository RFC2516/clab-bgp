# clab-bgp

This is a repository that I am creating to teach myself unit testing, portable infrastructure as code, configuration management and labbing content for the Cisco ENCOR Exam.

## Capabilities

*Testing*, *IaC*, *Configuration Management*, *Labs*

<table>
  <tr>
    <th>Testing</th>
    <th>IaC</th>
    <th>Configuration Management</th>
    <th>Labs</th>
  </tr>
  <tr>
    <td>Feel free to use this repository to perform your own testing. I've also included an example of unit testing to accomplish pre-lab deployment checks as necessary. </td>
    <td>In this repository I am using ContainerLab to serve as my Infrastructure as Code (IaC) orchestrator, feel free to review and copy my method in your own project!.</td>
    <td>In this repository I am using Ansible to provide configuration management, feel free to review and copy my method in your own project!</td>
    <td>This repository includes a lab folder which contains several scenarios. Using Ansible you can apply the configuration for each scenario by using the "Extra-Vars" option, which I will display an example below to better explain!</td>
  </tr>
</table>

## Testing

Currently I am only using Python Unit tests to 

## IaC

In this repository I am using [ContainerLab](https://containerlab.dev/) to serve as my Infrastructure as Code (IaC) orchestrator, feel free to review and copy my method in your own project!. From the ContainerLab documentation:

```
Containerlab provides a CLI for orchestrating and managing container-based networking labs. It starts the containers, builds a virtual wiring between them to create lab topologies of users choice and manages labs lifecycle.
```

You can get started with their install guide [here](https://containerlab.dev/install/). I am using Windows Subsystem for Linux as my local host, the warning provided in the documentation appears to be referring to WSL version 1. If you too choose to use the Windows Subsystem for Linux to run this project then ensure you are using [WSL version 2](https://containerlab.dev/install/).

Please review the asciinema recording below for an idea on how to perform lab resource management using ContainerLab.

[![asciicast](https://asciinema.org/a/553695.png)](https://asciinema.org/a/553695)


## Configuration Management

In this project I use ansible to configure each router for the lab scenario. The command is `ansible-playbook -i clab-bgp/ansible-inventory.yml -u admin -k configure.yaml -e lab=base`.

The command can be understood when broken down as such:

 * `-i clab-bgp/ansible-inventory.yml` the `-i` flag tells ansible to use a specific inventory file. The inventory file is generated by containerlab dynamically.
 * `-u admin -k` the use of the `-u` flag tells ansible to log into the routers using the `admin` user. The `-k` flag tells ansible to prompt for a password.
 * `-e lab=base` the use of the `-e` flag tells ansible that there are [extra variables](https://www.redhat.com/sysadmin/extra-variables-ansible-playbook) to be used in the play. This extra variable is used to specify which lab's configuration you want to deploy.

For an example of how to run the project and configure an example lab please consider this asciinema recording below.

[![asciicast](https://asciinema.org/a/553697.png)](https://asciinema.org/a/553697)

## Labs

You can check what labs are available by opening the `labs` directory. If you pass a lab into the extra variables portion of the Ansible play you will alerted if it is invalid and what valid labs are.

```bash
root@wsl2-debian:~/labs/routing/bgp# ansible-playbook -i clab-bgp/ansible-inventory.yml -u admin -k configure.yaml -e lab=wrong_lab_name
SSH password: 
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details

PLAY [Setting up the lab] **************************************************************************************************************************************************************************************************************

TASK [Check that the lab extra vars is defined] ****************************************************************************************************************************************************************************************
ok: [localhost] => {
    "changed": false,
    "msg": "All assertions passed"
}

TASK [check lab is valid] **************************************************************************************************************************************************************************************************************
fatal: [localhost]: FAILED! => {
    "assertion": "lab in labs",
    "changed": false,
    "evaluated_to": false,
    "msg": "Valid labs are, ['base', 'neighbors']."
}

PLAY RECAP *****************************************************************************************************************************************************************************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

root@wsl2-debian:~/labs/routing/bgp#
```

## Additional Considerations

Ansible by default will perform strict SSH Key checking. This means that between containerlab deployments the (identity) key used for SSH will change, but the hostname provided as part of that key will remain the same. This results in the SSH key Checking mechanism beleiving that someone is eavesdropping on the conversation. This however is not the case. It is simply that the original router you were talking to was destroyed and another was created when containerlab destroyed and deployed the lab.

I've provided an `ansible.cfg` file in this repository. Ansible should by default use this configuration file, but it if does not then you may export the environmental variable provided below to avoid this error.

`export ANSIBLE_HOST_KEY_CHECKING=False`